#### 0. Ref

![封面](.\Image\屏幕截图 2025-12-07 134057.png)

![Study case](.\Image\屏幕截图 2025-12-07 134151.png)



### 1. DAMON（Data Access MONitor）

​	DAMON是 Linux 内核的一个子系统，专门用于**数据访问监控**和**基于访问感知的系统操作**。

#### DAMON 的工作原理

##### A. 基于区域的抽样 (Region-based Sampling)

​	DAMON 不会跟踪每一个内存页（Page）。相反，它将虚拟地址空间划分为多个**区域 (Regions)**。

- 它假设同一个区域内的内存页具有相似的访问频率。
- 它只检查每个区域中的一个随机页面来推断整个区域的访问情况。

##### B. 自适应监控 (Adaptive Monitoring)

- **合并**：如果相邻的两个区域访问频率相似，DAMON 会将它们合并成一个大区域。
- **拆分**：如果一个区域内的访问模式变得复杂（不再均匀），DAMON 会将其拆分成多个小区域。

##### C. DAMOS (DAMON-based Operation Schemes)

​	DAMON 不仅仅是监控，它还允许用户定义**自动化操作方案 (Schemes)**。

- **规则示例**：“如果某个内存区域在过去 5 秒内没有被访问（冷数据），就将其换出 (Swap out) 到磁盘。”
- **自动化**：内核会根据 DAMON 监控到的实时数据，自动执行这些规则，无需用户空间的程序频繁干预。



### 2. DAMON可调节参数

#### 过滤参数 

| 参数名                | 含义                      | 作用与调节方向                                               |
| --------------------- | ------------------------- | ------------------------------------------------------------ |
| **`min_age`**         | **最小未访问时间** (微秒) | **最关键参数**。定义数据“冷”的程度。值越大，表示只有很久没被访问的数据才会被操作（如换出）。调大此值可以减少误伤热数据，但可能节省内存较少。 |
| **`max_age`**         | **最大未访问时间** (微秒) | 定义年龄的上限。通常设为最大值，表示“比 min_age 更老的所有数据”。 |
| **`min_access_rate`** | **最小访问频率** (%)      | 区域在监控周期内被访问的最小百分比。用于筛选“热”数据。       |
| **`max_access_rate`** | **最大访问频率** (%)      | 区域在监控周期内被访问的最大百分比。用于筛选“冷”数据（通常设为 0 或很低的值）。 |
| **`min_sz`**          | **最小区域大小** (字节)   | 只有大于此大小的连续内存区域才会被操作。调大此值可以减少碎片化操作，降低开销。 |
| **`max_sz`**          | **最大区域大小** (字节)   | 只有小于此大小的区域才会被操作。                             |

#### 动作参数

| 参数名       | 含义         | 常见用途                                                     |
| ------------ | ------------ | ------------------------------------------------------------ |
| **`action`** | **执行动作** | • **`pageout`**: 换出到 Swap（最常用，用于内存回收）。<br>• **`hugepage`**: 合并为大页，提升性能。<br>• **`nohugepage`**: 拆分大页，减少内存浪费。<br>• **`stat`**: 仅统计，不执行操作。 |

#### 监控质量参数 

这些参数控制 DAMON 监控本身的开销和精度，通常保持默认或固定值，但在手动调优时也很重要。

| 参数名                | 含义           | 作用                                                         |
| --------------------- | -------------- | ------------------------------------------------------------ |
| **`sample_interval`** | **采样间隔**   | 多久检查一次内存访问（如 5ms）。间隔越短，精度越高，CPU 开销越大。 |
| **`aggr_interval`**   | **聚合间隔**   | 多久汇总一次采样结果并更新区域（如 100ms）。这是计算 `age` 和 `access_rate` 的时间基准。 |
| **`update_interval`** | **更新间隔**   | 多久调整一次虚拟地址空间的映射关系（如 1s）。                |
| **`min_nr_regions`**  | **最小区域数** | 保持监控区域数量的下限（如 10）。                            |
| **`max_nr_regions`**  | **最大区域数** | 限制监控区域数量的上限（如 1000）。防止区域过多导致 CPU 开销失控。 |



### 3. Study Case - [DAMOOS](https://github.com/awslabs/damoos)

#### a. intro

​	搜索不同的参数组合，